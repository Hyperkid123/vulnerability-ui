import { Popover, Stack, StackItem, Text, TextContent, TextVariants } from '@patternfly/react-core';
import { ExternalLinkAltIcon } from '@patternfly/react-icons';
import { parseCvssScore } from '@redhat-cloud-services/frontend-components-utilities/files/helpers';
import propTypes from 'prop-types';
import React from 'react';
import { getImpactDetails } from '../../../Helpers/MiscHelper';
import CVEInfoBox from '../CVEInfoBox/CVEInfoBox';
import CvssVector from '../CvssVector/CvssVector';

class CVEPageDetailsSeverity extends React.Component {
    constructor(props) {
        super(props);
        this.cvssScore = parseCvssScore(this.props.cvss2_score, this.props.cvss3_score);
    }

    render() {
        const cveDetails = getImpactDetails(this.props.impact);
        const cvssVersion = (this.props.cvss3_score && 'CVSS 3.0') || (this.props.cvss2_score && 'CVSS 2.0') || 'CVSS 3.0';
        const learnMorePopover = (
            <Popover
                position="bottom"
                enableFlip={true}
                headerContent={<div>{cveDetails.title + ' impact'}</div>}
                bodyContent={
                    <TextContent>
                        <Text component={TextVariants.p}>{cveDetails.text}</Text>
                    </TextContent>
                }
                footerContent={
                    <a
                        href="https://access.redhat.com/security/updates/classification/"
                        target="_blank"
                        rel="noopener noreferrer"
                    >
                        Learn more about security ratings
                        <ExternalLinkAltIcon />
                    </a>
                }
            >
                <a>Learn more</a>
            </Popover>
        );
        return (
            <React.Fragment>
                <Stack gutter="sm">
                    <StackItem>
                        <CVEInfoBox
                            titleColor={cveDetails.color}
                            titleContent={cveDetails.titleContent}
                            descriptionTitle={cveDetails.title + ' impact'}
                            descriptionContent={learnMorePopover}
                        />
                    </StackItem>
                    <StackItem>
                        <CVEInfoBox
                            titleContent={
                                <TextContent>
                                    <Text component={TextVariants.h3}>
                                        {parseCvssScore(this.props.cvss2_score, this.props.cvss3_score)}
                                    </Text>
                                </TextContent>
                            }
                            descriptionTitle={cvssVersion + ' base score'}
                        />
                    </StackItem>

                    <StackItem>
                        <CvssVector cvss2_metrics={this.props.cvss2_metrics} cvss3_metrics={this.props.cvss3_metrics} />
                    </StackItem>
                </Stack>
            </React.Fragment>
        );
    }
}

CVEPageDetailsSeverity.defaultProps = {
    impact: 'Unknown',
    cvss2_score: undefined,
    cvss3_score: undefined,
    cvss2_metrics: undefined,
    cvss3_metrics: undefined
};

CVEPageDetailsSeverity.propTypes = {
    impact: propTypes.string,
    cvss2_score: propTypes.any,
    cvss3_score: propTypes.any,
    cvss2_metrics: propTypes.any,
    cvss3_metrics: propTypes.any
};

export default CVEPageDetailsSeverity;
